version: "3"

dotenv: ['.env']

vars:
  CLUSTERS:
    sh: echo $(find ./create -type f -iname '*.yaml')

output:
  group:
    error_only: true

tasks:
  create-cluster:
    internal: true
    cmds:
    - kind create cluster --config "{{.CLUSTER_CONFIG_PATH}}"
    - flux bootstrap gitlab --token-auth --owner {{.REPO_OWNER}} --repository {{.REPO_NAME}} --path "./clusters/{{.CLUSTER_NAME}}" --context kind-{{.CLUSTER_NAME}}
    vars:
      CLUSTER_NAME:
        sh: yq '.name' < "{{.CLUSTER_CONFIG_PATH}}"
    status:
    - kubectl cluster-info --context kind-{{.CLUSTER_NAME}}

  delete-cluster:
    internal: true
    cmds:
    - kind delete cluster --name "{{.CLUSTER_NAME}}"
    vars:
      CLUSTER_NAME:
        sh: yq '.name' < "{{.CLUSTER_CONFIG_PATH}}"

  create:
    deps:
    - task: create-cluster
      vars: 
        CLUSTER_CONFIG_PATH: "create/production.yaml"
    - task: create-cluster
      vars: 
        CLUSTER_CONFIG_PATH: "create/staging.yaml"
    - task: create-cluster
      vars: 
        CLUSTER_CONFIG_PATH: "create/development.yaml"
    cmds:
    - echo "Deployed!"


  delete:
    cmds:
    - task: delete-cluster
      vars: 
        CLUSTER_CONFIG_PATH: "create/production.yaml"
    - task: delete-cluster
      vars: 
        CLUSTER_CONFIG_PATH: "create/staging.yaml"
    - task: delete-cluster
      vars: 
        CLUSTER_CONFIG_PATH: "create/development.yaml"
    - echo "Destroyed!"